# Caddy configuration example for Poweradmin
# This configuration should be placed in your Caddyfile
# Based on the devcontainer configuration

your-domain.com {
    # Set the root directory
    root * /path/to/poweradmin

    # Enable access logs
    log {
        output stdout
        format console
        level INFO
    }

    # Security: Deny access to sensitive directories
    @denied path /config* /lib* /tests* /vendor*
    @bootstrap path /vendor/twbs/bootstrap* /vendor/twbs/bootstrap-icons*

    # Allow Bootstrap files (override general vendor blocking)
    handle @bootstrap {
        file_server
    }

    # Block sensitive directories (excluding bootstrap)
    handle @denied {
        respond "Forbidden" 403
    }

    # Security: Deny access to hidden files and sensitive file types
    @hidden path .* *.sql *.md *.log *.yaml *.yml
    handle @hidden {
        respond "Forbidden" 403
    }

    # Static assets with caching
    @static path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    handle @static {
        header Cache-Control "public, max-age=31536000"
        file_server
    }

    # Handle OPTIONS preflight requests for CORS
    @options method OPTIONS
    handle @options {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key"
        header Access-Control-Max-Age "3600"
        respond "" 204
    }

    # API endpoints with CORS
    @api path /api*
    handle @api {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key"
        header Access-Control-Max-Age "3600"

        # Forward API requests to index.php with page parameter (router handles leading slash)
        rewrite * /index.php?page={path}&{query}
        reverse_proxy localhost:9000 {
            transport fastcgi {
                split .php
                read_timeout 180s
                env HTTP_AUTHORIZATION {http.request.header.Authorization}
            }
            # Handle 204 No Content responses properly (fixes PHP-FPM/Caddy issue)
            @empty status 204
            handle_response @empty {
                header Content-Length "0"
                respond "" 204
            }
        }
    }

    # Handle PHP files - must be executed, not served as static text
    @phpfiles path *.php
    handle @phpfiles {
        php_fastcgi localhost:9000 {
            read_timeout 180s
            env HTTP_AUTHORIZATION {http.request.header.Authorization}
        }
    }

    # Handle all other requests - Clean URL routing
    handle {
        # Route non-existent paths to PHP router
        @rewritable not file
        handle @rewritable {
            rewrite * /index.php?page={path}&{query}
            php_fastcgi localhost:9000 {
                read_timeout 180s
                env HTTP_AUTHORIZATION {http.request.header.Authorization}
            }
        }

        # Serve static files directly (CSS, JS, images, etc.)
        file_server
    }
}
