services:
  # =============================================================================
  # PHP-FPM Application Containers
  # =============================================================================

  # PHP-FPM for MySQL (used by nginx)
  app-mysql:
    container_name: poweradmin-mysql
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VARIANT=${PHP_VERSION}-fpm-${DEBIAN_VERSION}
    volumes:
      - ../.:/app
      - ./conf/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - ./conf/error_reporting.ini:/usr/local/etc/php/conf.d/error_reporting.ini
      - ../..:/workspaces:cached
      - ./conf/settings-mysql.php:/app/config/settings.php
    networks:
      - internal
    environment:
      - PHP_IDE_CONFIG=serverName=localhost
    depends_on:
      mysql:
        condition: service_healthy

  # PHP-FPM for SQLite (used by caddy)
  app-sqlite:
    container_name: poweradmin-sqlite
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VARIANT=${PHP_VERSION}-fpm-${DEBIAN_VERSION}
    volumes:
      - ../.:/app
      - ./conf/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - ./conf/error_reporting.ini:/usr/local/etc/php/conf.d/error_reporting.ini
      - ../..:/workspaces:cached
      - sqlite_data:/data
      - ./conf/settings-sqlite.php:/app/config/settings.php
    networks:
      - internal
    environment:
      - PHP_IDE_CONFIG=serverName=localhost
    depends_on:
      - sqlite

  # =============================================================================
  # Web Servers
  # =============================================================================

  # Nginx webserver (MySQL) - Port 8080
  webserver:
    image: nginx:latest
    container_name: web-mysql
    networks:
      - internal
    ports:
      - "8080:80"
    volumes:
      - ./conf/nginx.conf:/etc/nginx/conf.d/default.conf
      - ../.:/app
      - ./conf/settings-mysql.php:/app/config/settings.php
    depends_on:
      - app-mysql

  # Apache webserver (PostgreSQL) - Port 8081
  apache:
    build:
      context: .
      dockerfile: apache.Dockerfile
    container_name: web-pgsql
    networks:
      - internal
    ports:
      - "8081:80"
    volumes:
      - ../.:/app
      - ./conf/settings-pgsql.php:/app/config/settings.php
    depends_on:
      pgsql:
        condition: service_healthy

  # Caddy webserver (SQLite) - Port 8082
  caddy:
    image: caddy:2-alpine
    container_name: web-sqlite
    networks:
      - internal
    ports:
      - "8082:80"
    volumes:
      - ./conf/Caddyfile:/etc/caddy/Caddyfile
      - ../.:/app
      - sqlite_data:/data
      - caddy_data:/data/caddy
      - caddy_config:/config/caddy
      - ./conf/settings-sqlite.php:/app/config/settings.php
    depends_on:
      - app-sqlite

  # =============================================================================
  # Database Servers
  # =============================================================================

  mysql:
    image: ${MYSQL_IMAGE}:${MYSQL_VERSION}
    container_name: mariadb
    networks:
      - internal
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_IMAGE: ${MYSQL_IMAGE}
    volumes:
      - mysql_data:/var/lib/mysql
      - ../sql/pdns/${PDNS_BRANCH}/schema.mysql.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./scripts/mysql-init-poweradmin.sh:/docker-entrypoint-initdb.d/02-poweradmin.sh
      - ./scripts/custom-healthcheck.sh:/custom-healthcheck.sh
    ports:
      - "3306:3306"
    healthcheck:
      test: [ "CMD", "/custom-healthcheck.sh" ]
      start_period: 1m
      start_interval: 10s
      interval: 30s
      timeout: 5s
      retries: 3

  pgsql:
    image: ${PGSQL_IMAGE}:${PGSQL_VERSION}
    container_name: postgres
    networks:
      - internal
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgsql_data:/var/lib/postgresql/data
      - ../sql/pdns/${PDNS_BRANCH}/schema.pgsql.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./scripts/postgres-init-keycloak.sh:/docker-entrypoint-initdb.d/02-keycloak.sh
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 30s
      timeout: 5s
      retries: 3

  sqlite:
    image: keinos/sqlite3
    container_name: sqlite
    user: "0:0"
    networks:
      - internal
    volumes:
      - sqlite_data:/data
      - ../sql/pdns/${PDNS_BRANCH}/schema.sqlite3.sql:/schema.sqlite3.sql
      - ./scripts/create-sqlite-db.sh:/init-db.sh
    command: ["/bin/sh", "-c", "/init-db.sh && tail -f /dev/null"]
    stdin_open: true
    tty: true

  # =============================================================================
  # PowerDNS Servers (one per database type - all with DNSSEC enabled)
  # =============================================================================

  pdns-mysql:
    image: powerdns/pdns-auth-${PDNS_BRANCH}:${PDNS_VERSION}
    container_name: pdns-mysql
    networks:
      - internal
    volumes:
      - ./conf/pdns-mysql.conf:/etc/powerdns/pdns.conf
    ports:
      - "1053:53"
      - "1053:53/udp"
      - "8181:8081"
    depends_on:
      mysql:
        condition: service_healthy

  pdns-pgsql:
    image: powerdns/pdns-auth-${PDNS_BRANCH}:${PDNS_VERSION}
    container_name: pdns-pgsql
    networks:
      - internal
    volumes:
      - ./conf/pdns-pgsql.conf:/etc/powerdns/pdns.conf
    ports:
      - "1054:53"
      - "1054:53/udp"
      - "8182:8081"
    depends_on:
      pgsql:
        condition: service_healthy

  pdns-sqlite:
    image: powerdns/pdns-auth-${PDNS_BRANCH}:${PDNS_VERSION}
    container_name: pdns-sqlite
    networks:
      - internal
    volumes:
      - ./conf/pdns-sqlite.conf:/etc/powerdns/pdns.conf
      - sqlite_data:/data
    ports:
      - "1055:53"
      - "1055:53/udp"
      - "8183:8081"
    depends_on:
      - sqlite

  # =============================================================================
  # Admin Tools
  # =============================================================================

  adminer:
    image: adminer
    container_name: adminer
    networks:
      - internal
    ports:
      - "8090:8080"
    volumes:
      - sqlite_data:/data
      - ./adminer/login-password-less.php:/var/www/html/plugins-enabled/login-password-less.php

  # =============================================================================
  # LDAP Server (for LDAP authentication testing)
  # =============================================================================

  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    networks:
      - internal
    environment:
      - LDAP_ORGANISATION=poweradmin
      - LDAP_DOMAIN=poweradmin.org
      - "LDAP_BASE_DN=dc=poweradmin,dc=org"
      - LDAP_ADMIN_PASSWORD=poweradmin
    volumes:
      - ./ldap/ldap-test-user.ldif:/ldap-test-user.ldif:ro
    ports:
      - 389:389
      - 636:636
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -x -H ldap://localhost -b dc=poweradmin,dc=org -D 'cn=admin,dc=poweradmin,dc=org' -w poweradmin"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  ldapadmin:
    image: osixia/phpldapadmin:0.9.0
    container_name: ldapadmin
    networks:
      - internal
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=ldap
    ports:
      - 8443:443

  # =============================================================================
  # Keycloak (commented out by default - uncomment to use)
  # =============================================================================

  # keycloak:
  #   image: quay.io/keycloak/keycloak:24.0
  #   container_name: keycloak
  #   networks:
  #     - internal
  #   environment:
  #     - KEYCLOAK_ADMIN=admin
  #     - KEYCLOAK_ADMIN_PASSWORD=admin
  #     - KC_DB=postgres
  #     - KC_DB_URL=jdbc:postgresql://pgsql:5432/keycloak
  #     - KC_DB_USERNAME=keycloak
  #     - KC_DB_PASSWORD=keycloak
  #     - KC_HOSTNAME_STRICT=false
  #     - KC_HOSTNAME_STRICT_HTTPS=false
  #     - KC_HTTP_ENABLED=true
  #   ports:
  #     - "8084:8080"
  #   command: ["start-dev"]
  #   depends_on:
  #     pgsql:
  #       condition: service_healthy
  #   volumes:
  #     - ./scripts/keycloak-init.sh:/opt/keycloak/bin/keycloak-init.sh

volumes:
  mysql_data: { }
  pgsql_data: { }
  sqlite_data: {}
  caddy_data: {}
  caddy_config: {}

networks:
  internal:
    driver: bridge
