services:
  # =============================================================================
  # PHP-FPM Application Containers (one per database type)
  # =============================================================================

  app-mysql:
    container_name: poweradmin-mysql
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VARIANT=${PHP_VERSION}-fpm-${DEBIAN_VERSION}
    volumes:
      - ../.:/app
      - ./conf/error_reporting.ini:/usr/local/etc/php/conf.d/error_reporting.ini
      - ./conf/config-mysql.inc.php:/app/inc/config.inc.php
      - ../..:/workspaces:cached
    networks:
      - internal
    environment:
      - PHP_IDE_CONFIG=serverName=localhost
    depends_on:
      mysql:
        condition: service_healthy

  app-pgsql:
    container_name: poweradmin-pgsql
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VARIANT=${PHP_VERSION}-fpm-${DEBIAN_VERSION}
    volumes:
      - ../.:/app
      - ./conf/error_reporting.ini:/usr/local/etc/php/conf.d/error_reporting.ini
      - ./conf/config-pgsql.inc.php:/app/inc/config.inc.php
      - ../..:/workspaces:cached
    networks:
      - internal
    environment:
      - PHP_IDE_CONFIG=serverName=localhost
    depends_on:
      pgsql:
        condition: service_healthy

  app-sqlite:
    container_name: poweradmin-sqlite
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VARIANT=${PHP_VERSION}-fpm-${DEBIAN_VERSION}
    volumes:
      - ../.:/app
      - ./conf/error_reporting.ini:/usr/local/etc/php/conf.d/error_reporting.ini
      - ./conf/config-sqlite.inc.php:/app/inc/config.inc.php
      - ../..:/workspaces:cached
      - sqlite_data:/data
    networks:
      - internal
    environment:
      - PHP_IDE_CONFIG=serverName=localhost
    depends_on:
      - sqlite

  # =============================================================================
  # Web Servers (Nginx - one per database type)
  # =============================================================================

  web-mysql:
    image: nginx:latest
    container_name: web-mysql
    networks:
      - internal
    ports:
      - "8080:80"
    volumes:
      - ./conf/nginx-mysql.conf:/etc/nginx/conf.d/default.conf
      - ../.:/app
    depends_on:
      - app-mysql

  web-pgsql:
    image: nginx:latest
    container_name: web-pgsql
    networks:
      - internal
    ports:
      - "8081:80"
    volumes:
      - ./conf/nginx-pgsql.conf:/etc/nginx/conf.d/default.conf
      - ../.:/app
    depends_on:
      - app-pgsql

  web-sqlite:
    image: nginx:latest
    container_name: web-sqlite
    networks:
      - internal
    ports:
      - "8082:80"
    volumes:
      - ./conf/nginx-sqlite.conf:/etc/nginx/conf.d/default.conf
      - ../.:/app
    depends_on:
      - app-sqlite

  # =============================================================================
  # Database Servers
  # =============================================================================

  mysql:
    image: ${MYSQL_IMAGE}:${MYSQL_VERSION}
    container_name: mariadb
    networks:
      - internal
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_IMAGE: ${MYSQL_IMAGE}
    volumes:
      - mysql_data:/var/lib/mysql
      - ../sql/pdns/${PDNS_BRANCH}/schema.mysql.sql:/docker-entrypoint-initdb.d/01-pdns.sql
      - ../sql/poweradmin-mysql-db-structure.sql:/docker-entrypoint-initdb.d/poweradmin-schema.sql
      - ./scripts/init-poweradmin-db.sh:/docker-entrypoint-initdb.d/02-init-poweradmin.sh
      - ./scripts/custom-healthcheck.sh:/custom-healthcheck.sh
    ports:
      - "3306:3306"
    healthcheck:
      test: [ "CMD", "/custom-healthcheck.sh" ]
      start_period: 1m
      start_interval: 10s
      interval: 30s
      timeout: 5s
      retries: 3

  pgsql:
    image: ${PGSQL_IMAGE}:${PGSQL_VERSION}
    container_name: postgres
    networks:
      - internal
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgsql_data:/var/lib/postgresql/data
      - ../sql/pdns/${PDNS_BRANCH}/schema.pgsql.sql:/docker-entrypoint-initdb.d/01-pdns.sql
      - ../sql/poweradmin-pgsql-db-structure.sql:/docker-entrypoint-initdb.d/02-poweradmin.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 30s
      timeout: 5s
      retries: 3

  sqlite:
    image: keinos/sqlite3
    container_name: sqlite
    user: "0:0"
    networks:
      - internal
    volumes:
      - sqlite_data:/data
      - ../sql/pdns/${PDNS_BRANCH}/schema.sqlite3.sql:/schema.sqlite3.sql
      - ../sql/poweradmin-sqlite-db-structure.sql:/poweradmin-schema.sql
      - ./scripts/create-sqlite-db.sh:/init-db.sh
    command: ["/bin/sh", "-c", "/init-db.sh && tail -f /dev/null"]
    stdin_open: true
    tty: true

  # =============================================================================
  # PowerDNS Servers (one per database type - all with DNSSEC enabled)
  # =============================================================================

  pdns-mysql:
    image: powerdns/pdns-auth-${PDNS_BRANCH}:${PDNS_VERSION}
    container_name: pdns-mysql
    networks:
      - internal
    volumes:
      - ./conf/pdns-mysql.conf:/etc/powerdns/pdns.conf
    ports:
      - "1053:53"
      - "1053:53/udp"
      - "8181:8081"
    depends_on:
      mysql:
        condition: service_healthy

  pdns-pgsql:
    image: powerdns/pdns-auth-${PDNS_BRANCH}:${PDNS_VERSION}
    container_name: pdns-pgsql
    networks:
      - internal
    volumes:
      - ./conf/pdns-pgsql.conf:/etc/powerdns/pdns.conf
    ports:
      - "1054:53"
      - "1054:53/udp"
      - "8182:8081"
    depends_on:
      pgsql:
        condition: service_healthy

  pdns-sqlite:
    image: powerdns/pdns-auth-${PDNS_BRANCH}:${PDNS_VERSION}
    container_name: pdns-sqlite
    networks:
      - internal
    volumes:
      - ./conf/pdns-sqlite.conf:/etc/powerdns/pdns.conf
      - sqlite_data:/data
    ports:
      - "1055:53"
      - "1055:53/udp"
      - "8183:8081"
    depends_on:
      - sqlite

  # =============================================================================
  # Admin Tools
  # =============================================================================

  adminer:
    image: adminer
    container_name: adminer
    networks:
      - internal
    ports:
      - "8090:8080"
    volumes:
      - sqlite_data:/data
      - ./adminer/login-password-less.php:/var/www/html/plugins-enabled/login-password-less.php

  # =============================================================================
  # LDAP Server (optional - for LDAP authentication testing)
  # =============================================================================

  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    networks:
      - internal
    environment:
      - LDAP_ORGANISATION=poweradmin
      - LDAP_DOMAIN=poweradmin.org
      - "LDAP_BASE_DN=dc=poweradmin,dc=org"
      - LDAP_ADMIN_PASSWORD=poweradmin
    volumes:
      - ./ldap/ldap-test-users.ldif:/ldap-test-users.ldif:ro
    ports:
      - 389:389
      - 636:636
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -x -H ldap://localhost -b dc=poweradmin,dc=org -D 'cn=admin,dc=poweradmin,dc=org' -w poweradmin"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  ldapadmin:
    image: osixia/phpldapadmin:0.9.0
    container_name: ldapadmin
    networks:
      - internal
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=ldap
    ports:
      - 8443:443

volumes:
  mysql_data: { }
  pgsql_data: { }
  sqlite_data: {}

networks:
  internal:
    driver: bridge
