<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ base_url_prefix }}/">{% trans %}Home{% endtrans %}</a></li>
        <li class="breadcrumb-item">
            {% if is_reverse_zone %}
            <a href="{{ base_url_prefix }}/zones/reverse">{% trans %}Reverse Zones{% endtrans %}</a>
            {% else %}
            <a href="{{ base_url_prefix }}/zones/forward">{% trans %}Forward Zones{% endtrans %}</a>
            {% endif %}
        </li>
        <li class="breadcrumb-item">
            {% if idn_zone_name %}
            {{ idn_zone_name }}
            {% else %}
            {{ zone_name_to_display }}
            {% endif %}
        </li>
        <li class="breadcrumb-item" aria-current="page">{% trans %}Edit{% endtrans %}</li>
    </ol>
</nav>

{% if (perm_edit == "all" or (perm_edit == "own" or perm_edit == "own_as_client") and user_is_zone_owner == "1") and domain_type != "SLAVE" and iface_edit_add_record_top %}
<div class="card shadow-sm mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <strong><i class="bi bi-plus-circle me-2"></i>{% trans %}Add new record{% endtrans %}</strong>
        <div>
            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/records/add" class="btn btn-primary btn-sm me-1">
                <i class="bi bi-table me-1 text-white"></i>{% trans %}Multi-record mode{% endtrans %}
            </a>
            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/records/bulk" class="btn btn-secondary btn-sm">
                <i class="bi bi-file-earmark-text me-1 text-white"></i>{% trans %}Bulk add{% endtrans %}
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if form_data and form_data.error %}
        <div class="alert alert-danger py-2 small">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>
            {% if form_data.errorMessage is defined %}
                {{ form_data.errorMessage }}
            {% elseif form_data.multi_record_error %}
                {% if form_data.failure_count > 0 %}
                    {% trans %}Failed to add {% endtrans %}{{ form_data.failure_count }} {% trans %}record(s). Please check the record format.{% endtrans %}
                {% else %}
                    {% trans %}Failed to add records. Please check the record format.{% endtrans %}
                {% endif %}
            {% elseif form_data.content %}
                {% trans %}Content validation failed:{% endtrans %} {% trans %}Invalid value for record type{% endtrans %} {{ form_data.type }}.
            {% else %}
                {% trans %}Please provide all required information.{% endtrans %}
            {% endif %}
        </div>
        {% endif %}
        <form class="{{ form_data and form_data.error ? 'was-validated' : 'needs-validation' }}" method="post" action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" novalidate>
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="domain" value="{{ zone_id }}">
            <input type="hidden" name="form_token" value="{{ form_token }}">
            <table class="table table-striped table-hover table-sm add-record-form">
                <tr>
                    <th>
                        {% trans %}Name{% endtrans %}
                    </th>
                    <th>{% trans %}Type{% endtrans %}</th>
                    <th>{% trans %}Content{% endtrans %}</th>
                    <th>{% trans %}Priority{% endtrans %}</th>
                    <th>{% trans %}TTL{% endtrans %}</th>
                    {% if iface_record_comments %}
                        <th>{% trans %}Comment{% endtrans %}</th>
                    {% endif %}
                    <th class="text-center">
                        {% if not is_reverse_zone and iface_add_reverse_record %}
                            {% trans %}Add PTR{% endtrans %}
                        {% endif %}
                        {% if is_reverse_zone and iface_add_domain_record %}
                            {% trans %}Add A/AAAA{% endtrans %}
                        {% endif %}
                    </th>
                    <th></th>
                </tr>
                <tr>
                    <td class="col-sm-2">
                        <input class="form-control form-control-sm {% if form_data.fieldError is defined and (form_data.fieldError == 'name' or form_data.fieldError == 'name-content-duplicate') %}is-invalid{% endif %}" 
                               type="text" name="name" value="{{ form_data.name|default('') }}" 
                               placeholder="">
                        {% if form_data.fieldError is defined and form_data.fieldError == 'name' %}
                        <div class="invalid-feedback">{% trans %}Invalid hostname format{% endtrans %}</div>
                        {% endif %}
                    </td>
                    <td class="col-sm-2">
                        <select id="recordTypeSelectTop" class="form-select form-select-sm" name="type" onchange="updateContentInput('recordTypeSelectTop', 'contentInputContainerTop', 'recordContentTop'); updatePriorityFieldState(this, 'priorityFieldTop');" {% if form_data.type %}data-preselect="{{ form_data.type }}"{% endif %}>
                            {% set rev = false %}
                            {% for record_type in record_types %}
                            {% set add = "" %}
                            {% if is_reverse_zone and record_type == "PTR" %}
                            {% set add = "SELECTED" %}
                            {% endif %}

                            {% if iface_add_reverse_record and record_type == "A" %}
                            {% set add = "SELECTED" %}
                            {% set rev = true %}
                            {% endif %}
                            <option {{ add }} value="{{ record_type }}">{{ record_type }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <div id="contentInputContainerTop">
                            <input id="recordContentTop" class="form-control form-control-sm {% if form_data.fieldError is defined and (form_data.fieldError == 'content' or form_data.fieldError == 'name-content-duplicate') %}is-invalid{% endif %}" 
                                   type="text" name="content" value="{{ form_data.content|default('') }}" required>
                        </div>
                        {% if form_data.fieldError is defined and form_data.fieldError == 'content' %}
                        <div class="invalid-feedback">{{ form_data.errorMessage }}</div>
                        {% elseif form_data.fieldError is defined and form_data.fieldError == 'name-content-duplicate' %}
                        <div class="invalid-feedback">{% trans %}This record already exists{% endtrans %}</div>
                        {% else %}
                        <div class="invalid-feedback">{% trans %}Provide content{% endtrans %}</div>
                        {% endif %}
                        <div id="cnameRootWarningTop" class="alert alert-warning mt-1 py-1 px-2 small" style="display: none;">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>{% trans %}Warning: CNAME records at the domain root (zone apex) are not recommended and may cause issues. SOA and NS records are required at the domain root and cannot coexist with CNAME.{% endtrans %}
                        </div>
                    </td>
                    <td class="col-sm-1">
                        <input id="priorityFieldTop" class="form-control form-control-sm {% if form_data.fieldError is defined and form_data.fieldError == 'prio' %}is-invalid{% endif %}" 
                               type="number" name="prio" value="{{ form_data.prio|default('0') }}" min="0" max="65535" pattern="[0-9]*">
                        {% if form_data.fieldError is defined and form_data.fieldError == 'prio' %}
                        <div class="invalid-feedback">{% trans %}Invalid priority{% endtrans %}</div>
                        {% endif %}
                    </td>
                    <td class="col-sm-1">
                        <input class="form-control form-control-sm {% if form_data.fieldError is defined and form_data.fieldError == 'ttl' %}is-invalid{% endif %}" 
                               type="number" name="ttl" min="0" max="2147483647" pattern="[0-9]*" value="{{ form_data.ttl|default(dns_ttl) }}" required>
                        {% if form_data.fieldError is defined and form_data.fieldError == 'ttl' %}
                        <div class="invalid-feedback">{% trans %}Invalid TTL value{% endtrans %}</div>
                        {% else %}
                        <div class="invalid-feedback">{% trans %}Provide TTL{% endtrans %}</div>
                        {% endif %}
                    </td>
                    {% if iface_record_comments %}
                    <td><input class="form-control form-control-sm" type="text" name="comment" value="{{ form_data.comment|default('') }}"></td>
                    {% endif %}
                    <td class="col-sm-1 text-center">
                        {% if not is_reverse_zone and iface_add_reverse_record %}
                        <span class="align-middle">
                            <input class="form-check-input" type="checkbox" name="reverse">
                        </span>
                        {% endif %}
                        {% if is_reverse_zone and iface_add_domain_record %}
                        <span class="align-middle">
                            <input class="form-check-input" type="checkbox" name="create_domain_record">
                        </span>
                        {% endif %}
                    </td>
                    <td class="col-sm-1">
                        <input class="btn btn-primary btn-sm" type="submit" name="commit"
                            value="{% trans %}Add record{% endtrans %}">
                    </td>
                </tr>
            </table>
            {% if not is_reverse_zone %}
            <small class="text-muted d-block mt-2">
                <i class="bi bi-info-circle"></i> 
                {% trans %}Tip: Enter just the hostname (e.g. 'www') and the zone name will be added automatically. Use '@' for the zone apex/root.{% endtrans %}
            </small>
            {% endif %}
        </form>
    </div>
</div>
{% endif %}

<div class="card shadow-sm mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <strong>
            <i class="bi bi-pencil-square me-2"></i>
            {% if idn_zone_name %}
            {% trans %}Edit zone{% endtrans %} "{{ idn_zone_name }}" ({{ zone_name_to_display }})
            {% else %}
            {% trans %}Edit zone{% endtrans %} "{{ zone_name_to_display }}"
            {% endif %}
        </strong>
        <div>
            {% if perm_edit != "none" and iface_edit_save_changes_top %}
            <button class="btn btn-primary btn-sm" type="submit" form="edit-zone-form" name="commit">
                <i class="bi bi-check-circle me-1 text-white"></i>{% trans %}Save changes{% endtrans %}
            </button>
            <button class="btn btn-secondary btn-sm" type="reset" form="edit-zone-form" name="reset">
                <i class="bi bi-arrow-counterclockwise me-1 text-white"></i>{% trans %}Reset{% endtrans %}
            </button>
            {% endif %}
            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?export_csv=1" class="btn btn-secondary btn-sm">
                <i class="bi bi-file-earmark-spreadsheet me-1 text-white"></i>{% trans %}CSV{% endtrans %}
            </a>
            {% if not is_reverse_zone and perm_edit != "none" %}
            <a href="{{ base_url_prefix }}/zones/batch-ptr?id={{ zone_id }}" class="btn btn-secondary btn-sm">
                <i class="bi bi-arrow-repeat me-1 text-white"></i>{% trans %}PTR{% endtrans %}
            </a>
            {% endif %}
            {% if perm_is_godlike and whois_enabled %}
            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/whois" class="btn btn-secondary btn-sm">
                <i class="bi bi-search-heart me-1 text-white"></i>{% trans %}WHOIS{% endtrans %}
            </a>
            {% endif %}
            {% if pdnssec_use %}
            {% if is_secured %}
            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/dnssec" class="btn btn-secondary btn-sm">
                <i class="bi bi-shield-lock me-1 text-white"></i>{% trans %}DNSSEC{% endtrans %}
            </a>
            {% else %}
                {% if perm_edit != "none" %}
                <button class="btn btn-secondary btn-sm" type="submit" form="edit-zone-form" name="sign_zone">
                    <i class="bi bi-shield-check me-1 text-white"></i>{% trans %}Sign zone{% endtrans %}
                </button>
                {% endif %}
            {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="card-body">
        <div class="mb-3">
            {{ pagination | raw }}
        </div>

        {% if not records %}
            {% if search_term or record_type_filter or content_filter %}
                <div class="d-flex align-items-center py-2 px-3 bg-light border rounded mb-3">
                    <i class="bi bi-info-circle me-2 text-info"></i>
                    <small>{% trans %}No records match your filter criteria.{% endtrans %}</small>
                    <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" class="btn btn-outline-secondary btn-sm ms-auto">
                        <i class="bi bi-x-circle me-1 text-secondary"></i>{% trans %}Clear{% endtrans %}
                    </a>
                </div>
            {% else %}
                <div class="alert alert-info py-2 small">
                    <i class="bi bi-info-circle me-2"></i>
                    {% trans %}This zone does not have any records.{% endtrans %}
                </div>
            {% endif %}
        {% else %}

        <!-- Record filtering section (single line) -->
        <div class="mb-3">
            <form id="record-filter-form" method="get" action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit">
                
                <div class="d-flex align-items-center py-2 px-3 {% if search_term or record_type_filter or content_filter %}border-primary{% endif %} border rounded">
                    <div class="me-2">
                        <i class="bi bi-funnel{% if search_term or record_type_filter or content_filter %}-fill text-primary{% endif %} me-1"></i>
                        <strong>{% trans %}Filter:{% endtrans %}</strong>
                    </div>
                    
                    <!-- Search term (filters name or content) -->
                    <div class="me-2" style="min-width: 220px;">
                        <input type="text" class="form-control form-control-sm {% if search_term %}border-primary{% endif %}" id="search" name="search" 
                               value="{{ search_term }}" placeholder="{% trans %}Search by name or content{% endtrans %}">
                    </div>
                    
                    <!-- Record type filter -->
                    <div class="me-2" style="min-width: 140px;">
                        <select class="form-select form-select-sm {% if record_type_filter %}border-primary{% endif %}" id="record_type" name="record_type">
                            <option value="">{% trans %}All Types{% endtrans %}</option>
                            {% for record_type in record_types %}
                            <option value="{{ record_type }}" {{ record_type_filter == record_type ? 'selected' : '' }}>{{ record_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Content filter -->
                    <div class="me-2" style="min-width: 180px;">
                        <input type="text" class="form-control form-control-sm {% if content_filter %}border-primary{% endif %}" id="content" name="content" 
                               value="{{ content_filter }}" placeholder="{% trans %}Filter by content{% endtrans %}">
                    </div>
                    
                    <!-- Filter buttons -->
                    <div class="ms-auto">
                        <button type="submit" class="btn btn-primary btn-sm me-1">
                            <i class="bi bi-funnel-fill me-1 text-white"></i>{% trans %}Apply{% endtrans %}
                        </button>
                        {% if search_term or record_type_filter or content_filter %}
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-x-circle me-1 text-primary"></i>{% trans %}Clear{% endtrans %}
                            </a>
                        {% else %}
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" class="btn btn-outline-secondary btn-sm disabled">
                                <i class="bi bi-x-circle me-1 text-secondary"></i>{% trans %}Clear{% endtrans %}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Records control section -->
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div>
                <form id="delete-records-form" method="post" action="{{ base_url_prefix }}/zones/records/delete" class="d-inline">
                    <input type="hidden" name="_token" value="{{ csrf_token }}">
                    <input type="hidden" name="zone_id" value="{{ zone_id }}">
                    <button type="submit" class="btn btn-danger btn-sm" id="delete-selected-records" disabled>
                        <i class="bi bi-trash me-1 text-white"></i>{% trans %}Delete record(s){% endtrans %}
                    </button>
                    <div id="selected-records-container"></div>
                </form>
                
                {% if filtered_record_count != record_count %}
                <span class="ms-3 small text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    {% trans %}Showing{% endtrans %} {{ filtered_record_count }} {% trans %}of{% endtrans %} {{ record_count }} {% trans %}total records{% endtrans %}
                </span>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                <label for="rows-per-page" class="me-2 text-secondary">{% trans %}Rows per page:{% endtrans %}</label>
                <select id="rows-per-page" class="form-select form-select-sm" style="width: auto;" onchange="changeRowsPerPage(this.value)">
                    <option value="10" {{ row_amount == 10 ? 'selected' : '' }}>10</option>
                    <option value="20" {{ row_amount == 20 ? 'selected' : '' }}>20</option>
                    <option value="50" {{ row_amount == 50 ? 'selected' : '' }}>50</option>
                    <option value="100" {{ row_amount == 100 ? 'selected' : '' }}>100</option>
                </select>
            </div>
        </div>

        <form id="edit-zone-form" class="needs-validation" method="post" action="" novalidate>
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="serial" value="{{ serial }}">

            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm add-record-form">
                    <thead class="table-light">
                    <tr>
                        <th class="text-center" style="width: 40px;">
                            <input type="checkbox" class="form-check-input" id="select_edit_records" onClick="toggleEditRecordCheckboxes()">
                        </th>
                        {% if iface_edit_show_id %}
                        <th>
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?record_sort_by=id&sort_direction={{ record_sort_by == 'id' and sort_direction == 'ASC' ? 'DESC' : 'ASC' }}">
                                {% trans %}Id{% endtrans %}
                            </a>
                            {% if record_sort_by == 'id' %}
                                <i class="bi bi-arrow-{{ sort_direction == 'ASC' ? 'down' : 'up' }}"></i>
                            {% endif %}
                        </th>
                        {% endif %}
                        <th>
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?record_sort_by=name&sort_direction={{ record_sort_by == 'name' and sort_direction == 'ASC' ? 'DESC' : 'ASC' }}">
                                {% trans %}Name{% endtrans %}
                            </a>
                            {% if record_sort_by == 'name' %}
                                <i class="bi bi-arrow-{{ sort_direction == 'ASC' ? 'down' : 'up' }}"></i>
                            {% endif %}
                        </th>
                        <th>
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?record_sort_by=type&sort_direction={{ record_sort_by == 'type' and sort_direction == 'ASC' ? 'DESC' : 'ASC' }}">
                                {% trans %}Type{% endtrans %}
                            </a>
                            {% if record_sort_by == 'type' %}
                                <i class="bi bi-arrow-{{ sort_direction == 'ASC' ? 'down' : 'up' }}"></i>
                            {% endif %}
                        </th>
                        <th>
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?record_sort_by=content&sort_direction={{ record_sort_by == 'content' and sort_direction == 'ASC' ? 'DESC' : 'ASC' }}">
                                {% trans %}Content{% endtrans %}
                            </a>
                            {% if record_sort_by == 'content' %}
                                <i class="bi bi-arrow-{{ sort_direction == 'ASC' ? 'down' : 'up' }}"></i>
                            {% endif %}
                        </th>
                        <th>
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?record_sort_by=prio&sort_direction={{ record_sort_by == 'prio' and sort_direction == 'ASC' ? 'DESC' : 'ASC' }}">
                                {% trans %}Priority{% endtrans %}
                            </a>
                            {% if record_sort_by == 'prio' %}
                                <i class="bi bi-arrow-{{ sort_direction == 'ASC' ? 'down' : 'up' }}"></i>
                            {% endif %}
                        </th>
                        <th>
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?record_sort_by=ttl&sort_direction={{ record_sort_by == 'ttl' and sort_direction == 'ASC' ? 'DESC' : 'ASC' }}">
                                {% trans %}TTL{% endtrans %}
                            </a>
                            {% if record_sort_by == 'ttl' %}
                                <i class="bi bi-arrow-{{ sort_direction == 'ASC' ? 'down' : 'up' }}"></i>
                            {% endif %}
                        </th>
                        {% if iface_record_comments %}
                        <th>{% trans %}Comment{% endtrans %}</th>
                        {% endif %}
                        <th>
                            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/edit?record_sort_by=disabled&sort_direction={{ record_sort_by == 'disabled' and sort_direction == 'ASC' ? 'DESC' : 'ASC' }}">
                                {% trans %}Disabled{% endtrans %}
                            </a>
                            {% if record_sort_by == 'disabled' %}
                                <i class="bi bi-arrow-{{ sort_direction == 'ASC' ? 'down' : 'up' }}"></i>
                            {% endif %}
                        </th>
                        <th class="text-end">{% trans %}Actions{% endtrans %}</th>
                    </tr>
                    </thead>
                    <tbody>
        {% for r in records %}

        {% if not(r['type'] == "SOA" or (r['type'] == "NS" and perm_edit == "own_as_client")) %}
        <input type="hidden" name="record[{{ r['id'] }}][rid]" value="{{ r['id'] }}">
        <input type="hidden" name="record[{{ r['id'] }}][zid]" value="{{ zone_id }}">
        {% endif %}
        <tr style="font-size: 14px;">
            <td class="text-center">
                {% if not(r['type'] == "SOA" or (r['type'] == "NS" and perm_edit == "own_as_client")) %}
                <input class="form-check-input" type="checkbox" name="record_id[]" value="{{ r['id'] }}">
                {% endif %}
            </td>
            {% if iface_edit_show_id %}
            <td>{{ r['id'] }}</td>
            {% endif %}
            {% if r['type'] == "SOA" or r['type'] == "NS" and perm_edit == "own_as_client" %}
            <td class="col-sm-2">{{ r['display_name'] is defined ? r['display_name'] : r['name'] }}</td>
            <td><span class="badge {% if r['type'] == 'SOA' %}bg-dark{% elseif r['type'] == 'NS' %}bg-info{% else %}bg-secondary{% endif %}">{{ r['type'] }}</span></td>
            <td>{{ r['content'] }}</td>
            <td>-</td>
            <td class="col-sm-1">{{ r['ttl'] }}</td>
            {% if iface_record_comments %}
            <td>{{ r['comment'] ?? '-' }}</td>
            {% endif %}
            <td class="text-center">{% if r['disabled'] %}{% trans %}Yes{% endtrans %}{% else %}{% trans %}No{% endtrans %}{% endif %}</td>
            {% else %}
            <td class="col-sm-2"><input class="form-control form-control-sm" type="text"
                                        name="record[{{ r['id'] }}][name]" value="{{ r['editable_name'] is defined ? r['editable_name'] : r['name'] }}"></td>
            <td>
                <input type="hidden" name="record[{{ r['id'] }}][type]" value="{{ r['type'] }}">
                <span class="badge {% if r['type'] == 'A' %}bg-primary{% elseif r['type'] == 'AAAA' %}bg-info{% elseif r['type'] == 'CNAME' %}bg-success{% elseif r['type'] == 'MX' %}bg-warning{% elseif r['type'] == 'TXT' %}bg-secondary{% elseif r['type'] == 'PTR' %}bg-danger{% elseif r['type'] == 'SOA' %}bg-dark{% elseif r['type'] == 'NS' %}bg-info{% else %}bg-secondary{% endif %}">{{ r['type'] }}</span>
            </td>
            <td>
                <div id="contentInputContainer{{ r['id'] }}">
                    <input id="recordContent{{ r['id'] }}" class="form-control form-control-sm" type="text" name="record[{{ r['id'] }}][content]" value="{{ r['content'] }}">
                </div>
            </td>
            <td><input class="form-control form-control-sm record-priority-field" type="number"
                                        id="priority_field_{{ r['id'] }}" name="record[{{ r['id'] }}][prio]"
                                        data-record-type="{{ r['type'] }}"
                                        min="0" max="65535" pattern="[0-9]*" value="{{ r['prio'] }}"></td>
            <td class="col-sm-1"><input class="form-control form-control-sm" type="text"
                                        min="0" max="2147483647" pattern="[0-9]*" name="record[{{ r['id'] }}][ttl]"
                                        value="{{ r['ttl'] }}"></td>
            {% if iface_record_comments %}
            <td class="col-sm-3"><input class="form-control form-control-sm" type="text" name="record[{{ r['id'] }}][comment]"
                       value="{{ r['comment'] }}"></td>
            {% endif %}
            <td class="text-center">
                <input class="form-check-input" type="checkbox" name="record[{{ r['id'] }}][disabled]" {% if r['disabled'] == 1 %}checked{% endif %}>
            </td>
            {% endif %}

            {% if domain_type == "SLAVE" or perm_edit == "none" or (perm_edit == "own" or perm_edit == "own_as_client") and user_is_zone_owner == "0" %}
            <td>&nbsp;</td>
            {% elseif r['type'] == "SOA" and perm_edit != "all" or r['type'] == "NS" and perm_edit == "own_as_client" %}
            <td>&nbsp;</td>
            {% else %}
            <td class="{{ iface_record_comments ? 'col-sm-1' : 'col-sm-2' }} text-end">
                <div class="gap-2">
                    <a class="btn btn-outline-primary btn-sm" href="{{ base_url_prefix }}/zones/{{ zone_id }}/records/{{ r['id'] }}/edit">
                        <i class="bi bi-pencil-square text-primary"></i></a>
                    <a class="btn btn-outline-danger btn-sm" href="{{ base_url_prefix }}/zones/{{ zone_id }}/records/{{ r['id'] }}/delete">
                        <i class="bi bi-trash text-danger"></i></a>
                </div>
            </td>
            {% endif %}
        </tr>
        {% endfor %}

        {% if iface_zone_comments %}
        <tr>
            {% if iface_edit_show_id %}
            <td></td>
            {% endif %}
            <td colspan="{% if not iface_record_comments %}8{% else %}9{% endif %}">{% trans %}Comments{% endtrans %}:</td>
        </tr>
        <tr>
            {% if iface_edit_show_id %}
            <td></td>
            {% endif %}
            <td colspan="7"><textarea class="form-control form-control-sm" rows="5" cols="80" name="comment">{{ zone_comment }}</textarea>
            </td>
            <td colspan="2">
                {% if perm_edit != "none" %}
                <a class="btn btn-outline-primary btn-sm" href="{{ base_url_prefix }}/zones/{{ zone_id }}/comment/edit">
                    <i class="bi bi-pencil-square text-primary"></i> {% trans %}Edit comment{% endtrans %}</a>
                {% endif %}
            </td>
        </tr>
        {% endif %}
                    </tbody>
                </table>
            </div>

            <div>
                {{ pagination | raw }}
            </div>

    {% endif %}

{% if perm_edit != "none" and not iface_edit_save_changes_top %}
<div class="card-footer py-3">
    <button class="btn btn-primary btn-sm" type="submit" name="commit">
        <i class="bi bi-check-circle me-1 text-white"></i>{% trans %}Save changes{% endtrans %}
    </button>
    <button class="btn btn-secondary btn-sm" type="reset" name="reset">
        <i class="bi bi-arrow-counterclockwise me-1 text-white"></i>{% trans %}Reset{% endtrans %}
    </button>
</div>
{% endif %}
</form>
</div>
</div>

{% if perm_edit == "all" or (perm_edit == "own" or perm_edit == "own_as_client") and user_is_zone_owner == "1" %}
{% if domain_type != "SLAVE" and not iface_edit_add_record_top %}
<div class="card shadow-sm mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <strong><i class="bi bi-plus-circle me-2"></i>{% trans %}Add new record{% endtrans %}</strong>
        <div>
            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/records/add" class="btn btn-primary btn-sm me-1">
                <i class="bi bi-table me-1 text-white"></i>{% trans %}Multi-record mode{% endtrans %}
            </a>
            <a href="{{ base_url_prefix }}/zones/{{ zone_id }}/records/bulk" class="btn btn-secondary btn-sm">
                <i class="bi bi-file-earmark-text me-1 text-white"></i>{% trans %}Bulk add{% endtrans %}
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if form_data and form_data.error %}
        <div class="alert alert-danger py-2 small">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>
            {% if form_data.errorMessage is defined %}
                {{ form_data.errorMessage }}
            {% elseif form_data.multi_record_error %}
                {% if form_data.failure_count > 0 %}
                    {% trans %}Failed to add {% endtrans %}{{ form_data.failure_count }} {% trans %}record(s). Please check the record format.{% endtrans %}
                {% else %}
                    {% trans %}Failed to add records. Please check the record format.{% endtrans %}
                {% endif %}
            {% elseif form_data.content %}
                {% trans %}Content validation failed:{% endtrans %} {% trans %}Invalid value for record type{% endtrans %} {{ form_data.type }}.
            {% else %}
                {% trans %}Please provide all required information.{% endtrans %}
            {% endif %}
        </div>
        {% endif %}
        <form class="{{ form_data and form_data.error ? 'was-validated' : 'needs-validation' }}" method="post" action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" novalidate>
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="domain" value="{{ zone_id }}">
            <input type="hidden" name="form_token" value="{{ form_token }}">

            <table class="table table-striped table-hover table-sm add-record-form">
                <tr>
                    <th>
                        {% trans %}Name{% endtrans %}
                    </th>
                    <th>{% trans %}Type{% endtrans %}</th>
                    <th>{% trans %}Content{% endtrans %}</th>
                    <th>{% trans %}Priority{% endtrans %}</th>
                    <th>{% trans %}TTL{% endtrans %}</th>
                    {% if iface_record_comments %}
                        <th>{% trans %}Comment{% endtrans %}</th>
                    {% endif %}
                    <th class="text-center">
                        {% if not is_reverse_zone and iface_add_reverse_record %}
                            {% trans %}Add PTR{% endtrans %}
                        {% endif %}
                        {% if is_reverse_zone and iface_add_domain_record %}
                            {% trans %}Add A/AAAA{% endtrans %}
                        {% endif %}
                    </th>
                    <th></th>
                </tr>
                <tr>
                    <td class="col-sm-2">
                        <input class="form-control form-control-sm {% if form_data.fieldError is defined and (form_data.fieldError == 'name' or form_data.fieldError == 'name-content-duplicate') %}is-invalid{% endif %}" 
                               type="text" name="name" value="{{ form_data.name|default('') }}" data-testid="record-name-input"
                               placeholder="">
                        {% if form_data.fieldError is defined and form_data.fieldError == 'name' %}
                        <div class="invalid-feedback">{% trans %}Invalid hostname format{% endtrans %}</div>
                        {% endif %}
                    </td>
                    <td class="col-sm-2">
                        <select id="recordTypeSelectBottom" class="form-select form-select-sm" name="type" onchange="updateContentInput('recordTypeSelectBottom', 'contentInputContainerBottom', 'recordContentBottom'); updatePriorityFieldState(this, 'priorityFieldBottom');" {% if form_data.type %}data-preselect="{{ form_data.type }}"{% endif %}>
                            {% set rev = false %}
                            {% for record_type in record_types %}
                            {% set add = "" %}
                            {% if is_reverse_zone and record_type == "PTR" %}
                            {% set add = "SELECTED" %}
                            {% endif %}

                            {% if iface_add_reverse_record and record_type == "A" %}
                            {% set add = "SELECTED" %}
                            {% set rev = true %}
                            {% endif %}
                            <option {{ add }} value="{{ record_type }}">{{ record_type }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <div id="contentInputContainerBottom">
                            <input id="recordContentBottom" class="form-control form-control-sm {% if form_data.fieldError is defined and (form_data.fieldError == 'content' or form_data.fieldError == 'name-content-duplicate') %}is-invalid{% endif %}" 
                                   type="text" name="content" value="{{ form_data.content|default('') }}" data-testid="record-content-input" required>
                        </div>
                        {% if form_data.fieldError is defined and form_data.fieldError == 'content' %}
                        <div class="invalid-feedback">{{ form_data.errorMessage }}</div>
                        {% elseif form_data.fieldError is defined and form_data.fieldError == 'name-content-duplicate' %}
                        <div class="invalid-feedback">{% trans %}This record already exists{% endtrans %}</div>
                        {% else %}
                        <div class="invalid-feedback">{% trans %}Provide content{% endtrans %}</div>
                        {% endif %}
                        <div id="cnameRootWarningBottom" class="alert alert-warning mt-1 py-1 px-2 small" style="display: none;">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>{% trans %}Warning: CNAME records at the domain root (zone apex) are not recommended and may cause issues. SOA and NS records are required at the domain root and cannot coexist with CNAME.{% endtrans %}
                        </div>
                    </td>
                    <td class="col-sm-1">
                        <input id="priorityFieldBottom" class="form-control form-control-sm {% if form_data.fieldError is defined and form_data.fieldError == 'prio' %}is-invalid{% endif %}" 
                               type="number" name="prio" value="{{ form_data.prio|default('0') }}" min="0" max="65535" pattern="[0-9]*">
                        {% if form_data.fieldError is defined and form_data.fieldError == 'prio' %}
                        <div class="invalid-feedback">{% trans %}Invalid priority{% endtrans %}</div>
                        {% endif %}
                    </td>
                    <td class="col-sm-1">
                        <input class="form-control form-control-sm {% if form_data.fieldError is defined and form_data.fieldError == 'ttl' %}is-invalid{% endif %}" 
                               type="number" name="ttl" min="0" max="2147483647" pattern="[0-9]*" value="{{ form_data.ttl|default(dns_ttl) }}" required>
                        {% if form_data.fieldError is defined and form_data.fieldError == 'ttl' %}
                        <div class="invalid-feedback">{% trans %}Invalid TTL value{% endtrans %}</div>
                        {% else %}
                        <div class="invalid-feedback">{% trans %}Provide TTL{% endtrans %}</div>
                        {% endif %}
                    </td>
                    {% if iface_record_comments %}
                        <td><input class="form-control form-control-sm" type="text" name="comment" value="{{ form_data.comment|default('') }}"></td>
                    {% endif %}
                    <td class="col-sm-1 text-center">
                        {% if not is_reverse_zone and iface_add_reverse_record %}
                        <span class="align-middle">
                            <input class="form-check-input" type="checkbox" name="reverse" data-testid="add-reverse-record-checkbox">
                        </span>
                        {% endif %}
                        {% if is_reverse_zone and iface_add_domain_record %}
                        <span class="align-middle">
                            <input class="form-check-input" type="checkbox" name="create_domain_record" data-testid="add-domain-record-checkbox">
                        </span>
                        {% endif %}
                    </td>
                    <td class="col-sm-1">
                        <input class="btn btn-primary btn-sm" type="submit" name="commit" data-testid="add-record-button"
                            value="{% trans %}Add record{% endtrans %}">
                    </td>
                </tr>
            </table>
            <small class="text-muted d-block mt-2">
                <i class="bi bi-info-circle"></i> 
                {% trans %}Tip: Enter just the hostname (e.g. 'www') and the zone name will be added automatically. Use '@' for the zone apex/root.{% endtrans %}
            </small>
        </form>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-6 mb-4">
        {% if (perm_zone_templ_add or perm_is_godlike) and domain_type != "SLAVE" %}
        <div class="card shadow-sm">
            <div class="card-header py-3">
                <strong><i class="bi bi-save me-2"></i>{% trans %}Save as new template{% endtrans %}</strong>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">{% trans %}Create a reusable template from this zone's records{% endtrans %}</p>

                <form class="needs-validation" method="post" action="" novalidate>
                    <input type="hidden" name="_token" value="{{ csrf_token }}">

                    <div class="mb-3">
                        <label for="templ_name" class="form-label">{% trans %}Template Name{% endtrans %}</label>
                        <input id="templ_name" class="form-control form-control-sm" type="text" name="templ_name" value="" required>
                        <div class="invalid-feedback">{% trans %}Provide template name{% endtrans %}</div>
                    </div>

                    <div class="mb-3">
                        <label for="templ_descr" class="form-label">{% trans %}Template Description{% endtrans %}</label>
                        <input id="templ_descr" class="form-control form-control-sm" type="text" name="templ_descr" value="">
                        <small class="text-muted">{% trans %}Optional description for this template{% endtrans %}</small>
                    </div>

                    <button class="btn btn-secondary btn-sm" type="submit" name="save_as">
                        <i class="bi bi-save me-1 text-white"></i>{% trans %}Save as template{% endtrans %}
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header py-3">
                <strong><i class="bi bi-gear me-2"></i>{% trans %}Zone Settings{% endtrans %}</strong>
            </div>
            <div class="card-body">
                <h6 class="card-subtitle mb-3 text-muted">{% trans %}Owner of zone{% endtrans %}</h6>
                {% if owners == "-1" %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>{% trans %}No owner set for this zone.{% endtrans %}
                </div>
                {% else %}
                <div class="mb-3">
                    <ul class="list-group">
                    {% if meta_edit %}
                        {% for owner in owners %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {% if owner["fullname"] %}
                            {{ owner["fullname"] }}
                            {% else %}
                            {{ owner["username"] }}
                            {% endif %}

                            <form method="post" action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" class="d-inline">
                                <input type="hidden" name="_token" value="{{ csrf_token }}">
                                <input type="hidden" name="delete_owner" value="{{ owner['id'] }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm" name="co">
                                    <i class="bi bi-trash text-danger"></i>
                                </button>
                            </form>
                        </li>
                        {% endfor %}
                    {% else %}
                        {% for owner in owners %}
                        <li class="list-group-item">
                            {% if owner["fullname"] %}
                            {{ owner["fullname"] }}
                            {% else %}
                            {{ owner["username"] }}
                            {% endif %}
                        </li>
                        {% endfor %}
                    {% endif %}
                    </ul>
                </div>
                {% endif %}

                {% if meta_edit %}
                <form method="post" action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" class="mb-4">
                    <input type="hidden" name="_token" value="{{ csrf_token }}">
                    <input type="hidden" name="domain" value="{{ zone_id }}">
                    <div class="input-group">
                        <select class="form-select form-select-sm" name="newowner">
                            {% for user in users %}
                            {% set add = "" %}
                            {% if user["id"] == session_userid %}
                            <option {{ add }} value="{{ user['id'] }}">{{ user["fullname"] }}</option>
                            {% elseif perm_view_others %}
                            <option value="{{ user['id'] }}">
                                {% if user["fullname"] %}
                                {{ user["fullname"] }}
                                {% else %}
                                {{ user["username"] }}
                                {% endif %}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-secondary btn-sm" type="submit" name="co">
                            <i class="bi bi-plus text-secondary"></i> {% trans %}Add{% endtrans %}
                        </button>
                    </div>
                </form>
                {% endif %}

                <h6 class="card-subtitle mb-2 text-muted">{% trans %}Type{% endtrans %}</h6>
                {% if meta_edit %}
                <form action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" method="post" class="mb-4">
                    <input type="hidden" name="_token" value="{{ csrf_token }}">
                    <input type="hidden" name="domain" value="{{ zone_id }}">
                    <div class="input-group">
                        <select class="form-select form-select-sm" name="newtype">
                            {% for type in zone_types %}
                            {% set add = '' %}
                            {% if type == domain_type %}
                            {% set add = "SELECTED" %}
                            {% endif %}
                            <option {{ add }} value="{{ type }}">{{ type | lower }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-secondary btn-sm" type="submit" name="type_change">
                            <i class="bi bi-arrow-repeat text-secondary"></i> {% trans %}Change{% endtrans %}
                        </button>
                    </div>
                </form>
                {% else %}
                <p class="card-text mb-4"><span class="badge bg-secondary">{{ domain_type | lower }}</span></p>
                {% endif %}

                {% if domain_type == "SLAVE" %}
                <h6 class="card-subtitle mb-2 text-muted">{% trans %}IP address of master NS{% endtrans %}</h6>
                {% if meta_edit %}
                <form action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" method="post" class="mb-4">
                    <input type="hidden" name="_token" value="{{ csrf_token }}">
                    <input type="hidden" name="domain" value="{{ zone_id }}">
                    <div class="input-group">
                        <input class="form-control form-control-sm" type="text" name="new_master" value="{{ slave_master }}">
                        <button class="btn btn-outline-secondary btn-sm" type="submit" name="slave_master_change">
                            <i class="bi bi-arrow-repeat text-secondary"></i> {% trans %}Change{% endtrans %}
                        </button>
                    </div>
                </form>
                {% else %}
                <p class="card-text mb-4"><code>{{ slave_master }}</code></p>
                {% endif %}
                {% endif %}

                <h6 class="card-subtitle mb-2 text-muted">{% trans %}Template{% endtrans %}</h6>
                {% if meta_edit %}
                <form action="{{ base_url_prefix }}/zones/{{ zone_id }}/edit" method="post">
                    <input type="hidden" name="_token" value="{{ csrf_token }}">
                    <input type="hidden" name="current_zone_template" value="{{ zone_template_id }}">
                    <div class="input-group">
                        <select class="form-select form-select-sm" name="zone_template">
                            <option value="none">none</option>
                            {% for zone_template in zone_templates %}
                            {% set add = '' %}
                            {% if zone_template['id'] == zone_template_id %}
                            {% set add = "SELECTED" %}
                            {% endif %}
                            <option {{ add }} value="{{ zone_template['id'] }}">{{ zone_template['name'] }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-secondary btn-sm" type="submit" name="template_change">
                            <i class="bi text-secondary bi-arrow-repeat"></i> {% trans %}Change{% endtrans %}
                        </button>
                    </div>
                </form>
                {% else %}
                <p class="card-text">
                    {% if zone_template_details %}
                    <span class="badge bg-info">{{ zone_template_details['name'] | lower }}</span>
                    {% else %}
                    <span class="badge bg-secondary">none</span>
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="assets/textareaAutoResize.js?time={{ file_version }}"></script>

<script>
    // Record types that support priority field
    const RECORD_TYPES_WITH_PRIORITY = ['MX', 'SRV', 'KX', 'NAPTR'];
    
    // Function to check if a record type supports priority
    function supportsPriority(recordType) {
        return RECORD_TYPES_WITH_PRIORITY.includes(recordType);
    }
    
    // Function to update priority field state based on record type
    function updatePriorityFieldState(selectElement, priorityInputId) {
        const recordType = selectElement.value;
        const priorityInput = document.getElementById(priorityInputId);
        
        if (priorityInput) {
            if (supportsPriority(recordType)) {
                priorityInput.removeAttribute('readonly');
                priorityInput.classList.remove('bg-dark-subtle');
                priorityInput.setAttribute('tabindex', '0');
            } else {
                priorityInput.setAttribute('readonly', 'readonly');
                priorityInput.classList.add('bg-dark-subtle');
                priorityInput.value = '0';
                priorityInput.setAttribute('tabindex', '-1');
            }
        }
    }
    
    // Check if CNAME is being used at domain root and show warning if it is
    function checkCnameRootWarning(selectId, nameInputSelector, warningId) {
        const typeSelect = document.getElementById(selectId);
        const nameField = document.querySelector(nameInputSelector);
        const warningDiv = document.getElementById(warningId);
        
        if (!typeSelect || !nameField || !warningDiv) return;
        
        const isType = typeSelect.value === 'CNAME';
        const name = nameField.value.trim();
        const isAtRoot = (name === "" || name === "@");
        
        warningDiv.style.display = (isType && isAtRoot) ? 'block' : 'none';
    }
    
    // Set up event listeners for CNAME root warning
    function setupCnameWarningListeners(selectId, nameInputSelector, warningId) {
        const typeSelect = document.getElementById(selectId);
        const nameField = document.querySelector(nameInputSelector);
        
        if (typeSelect) {
            typeSelect.addEventListener('change', function() {
                checkCnameRootWarning(selectId, nameInputSelector, warningId);
            });
        }
        
        if (nameField) {
            nameField.addEventListener('input', function() {
                checkCnameRootWarning(selectId, nameInputSelector, warningId);
            });
        }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Handle pre-selected record types for form data restoration
        function setPreselectedType(selectId) {
            const typeSelect = document.getElementById(selectId);
            if (typeSelect && typeSelect.hasAttribute('data-preselect')) {
                const preselectedType = typeSelect.getAttribute('data-preselect');
                for (let i = 0; i < typeSelect.options.length; i++) {
                    if (typeSelect.options[i].value === preselectedType) {
                        typeSelect.selectedIndex = i;
                        // Trigger the change event to update the content input
                        const event = new Event('change');
                        typeSelect.dispatchEvent(event);
                        break;
                    }
                }
            }
        }
        
        // Apply to both top and bottom forms
        setPreselectedType('recordTypeSelectTop');
        setPreselectedType('recordTypeSelectBottom');
        
        // Initialize priority field states for add record forms
        const topTypeSelect = document.getElementById('recordTypeSelectTop');
        if (topTypeSelect) {
            updatePriorityFieldState(topTypeSelect, 'priorityFieldTop');
        }
        
        const bottomTypeSelect = document.getElementById('recordTypeSelectBottom');
        if (bottomTypeSelect) {
            updatePriorityFieldState(bottomTypeSelect, 'priorityFieldBottom');
        }
        
        // Initialize priority field states for existing records
        document.querySelectorAll('.record-priority-field').forEach(priorityField => {
            const recordType = priorityField.getAttribute('data-record-type');
            if (recordType && !supportsPriority(recordType)) {
                priorityField.setAttribute('readonly', 'readonly');
                priorityField.classList.add('bg-dark-subtle');
                priorityField.setAttribute('tabindex', '-1');
            }
        });
        
        // Handle disabled checkboxes
        document.querySelectorAll('input[type="checkbox"][name$="[disabled]"]').forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (!row) return;

            const toggleOpacity = () => row.classList.toggle('opacity-25', checkbox.checked);

            checkbox.addEventListener('change', toggleOpacity);
            toggleOpacity();
        });

        // Handle record selection checkboxes
        const recordCheckboxes = document.getElementsByName('record_id[]');
        for (let i = 0; i < recordCheckboxes.length; i++) {
            recordCheckboxes[i].addEventListener('change', function() {
                updateDeleteButtonState('delete-selected-records', recordCheckboxes);
                updateSelectedCount(recordCheckboxes);
            });
        }

        // Initialize delete button state
        updateDeleteButtonState('delete-selected-records', recordCheckboxes);
        
        // Select/deselect all records checkbox
        const selectAllCheckbox = document.getElementById('select_edit_records');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                toggleEditRecordCheckboxes();
                updateSelectedCount(recordCheckboxes);
            });
        }

        // Handle delete form submission
        document.getElementById('delete-records-form').addEventListener('submit', function(e) {
            // Get all checked checkboxes
            const checkedBoxes = document.querySelectorAll('input[name="record_id[]"]:checked');

            if (checkedBoxes.length === 0) {
                e.preventDefault();
                return;
            }

            const container = document.getElementById('selected-records-container');
            container.innerHTML = '';

            // Clone checked checkboxes to the delete form
            checkedBoxes.forEach(function(checkbox) {
                const clone = document.createElement('input');
                clone.type = 'hidden';
                clone.name = 'record_id[]';
                clone.value = checkbox.value;
                container.appendChild(clone);
            });
        });
        
        // Add "Select All Filtered" functionality
        if (document.getElementById('record-filter-form')) {
            // Create select all filtered button and add it next to the delete button
            const deleteForm = document.getElementById('delete-records-form');
            const deleteButton = document.getElementById('delete-selected-records');
            
            const selectAllFilteredBtn = document.createElement('button');
            selectAllFilteredBtn.type = 'button';
            selectAllFilteredBtn.classList.add('btn', 'btn-outline-secondary', 'btn-sm', 'ms-2');
            selectAllFilteredBtn.innerHTML = '<i class="bi bi-check-all me-1"></i>' + 
                                          (document.documentElement.lang === 'en' ? 'Select All Filtered' : '{% trans %}Select All Filtered{% endtrans %}');
            
            // Insert the button after the delete button
            if (deleteButton.nextSibling) {
                deleteForm.insertBefore(selectAllFilteredBtn, deleteButton.nextSibling);
            } else {
                deleteForm.appendChild(selectAllFilteredBtn);
            }
            
            // Add click handler to select all filtered records
            selectAllFilteredBtn.addEventListener('click', function() {
                const recordCheckboxes = document.getElementsByName('record_id[]');
                const allChecked = Array.from(recordCheckboxes).every(checkbox => checkbox.checked);
                
                // Toggle all checkboxes to the opposite state
                Array.from(recordCheckboxes).forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                
                // Update UI state
                updateDeleteButtonState('delete-selected-records', recordCheckboxes);
                updateSelectedCount(recordCheckboxes);
                
                // Update select all checkbox state
                const selectAllCheckbox = document.getElementById('select_edit_records');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = !allChecked;
                }
            });
        }
        
        // Create a selection counter
        const selectionCounterSpan = document.createElement('span');
        selectionCounterSpan.id = 'selection-counter';
        selectionCounterSpan.classList.add('ms-2', 'small', 'text-muted');
        selectionCounterSpan.style.display = 'none';
        
        // Find delete button and insert counter after it
        const deleteForm = document.getElementById('delete-records-form');
        if (deleteForm) {
            deleteForm.appendChild(selectionCounterSpan);
        }
        
        
        // Initialize selection counter
        updateSelectedCount(recordCheckboxes);
        
        // Set up CNAME root warning listeners for top and bottom forms
        setupCnameWarningListeners('recordTypeSelectTop', 'input[name="name"]', 'cnameRootWarningTop');
        setupCnameWarningListeners('recordTypeSelectBottom', 'input[name="name"][data-testid="record-name-input"]', 'cnameRootWarningBottom');
        
        // Initial check for CNAME warnings
        checkCnameRootWarning('recordTypeSelectTop', 'input[name="name"]', 'cnameRootWarningTop');
        checkCnameRootWarning('recordTypeSelectBottom', 'input[name="name"][data-testid="record-name-input"]', 'cnameRootWarningBottom');
        
    });
    
    // Function to update selected count display
    function updateSelectedCount(checkboxes) {
        const counterSpan = document.getElementById('selection-counter');
        if (!counterSpan) return;
        
        const selectedCount = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;
        const totalCount = checkboxes.length;
        
        if (selectedCount > 0) {
            counterSpan.textContent = selectedCount + ' of ' + totalCount + ' selected';
            counterSpan.style.display = 'inline-block';
        } else {
            counterSpan.style.display = 'none';
        }
    }
    
    // Function to update delete button state
    function updateDeleteButtonState(buttonId, checkboxes) {
        const button = document.getElementById(buttonId);
        if (!button) return;
        
        let hasChecked = false;
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                hasChecked = true;
                break;
            }
        }
        
        button.disabled = !hasChecked;
    }
    
    // Function to toggle all record checkboxes
    function toggleEditRecordCheckboxes() {
        const selectAllCheckbox = document.getElementById('select_edit_records');
        const recordCheckboxes = document.getElementsByName('record_id[]');
        const checked = selectAllCheckbox.checked;
        
        for (let i = 0; i < recordCheckboxes.length; i++) {
            recordCheckboxes[i].checked = checked;
        }
        
        updateDeleteButtonState('delete-selected-records', recordCheckboxes);
    }
    
    
</script>
