<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ base_url_prefix }}/">{% trans %}Home{% endtrans %}</a></li>
        <li class="breadcrumb-item">
        {% if is_reverse_zone %}
        <a href="{{ base_url_prefix }}/zones/reverse">{% trans %}Reverse Zones{% endtrans %}</a>
        {% else %}
        <a href="{{ base_url_prefix }}/zones/forward">{% trans %}Forward Zones{% endtrans %}</a>
        {% endif %}
    </li>
        <li class="breadcrumb-item" aria-current="page">{% trans %}Add master zone{% endtrans %}</li>
    </ol>
</nav>

<form class="needs-validation" method="post" action="{{ base_url_prefix }}/zones/add/master" novalidate>
    <input type="hidden" name="_token" value="{{ csrf_token }}">

<!-- Zone Configuration (Full Width) -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3">
                <strong><i class="bi bi-gear me-2"></i>{% trans %}Zone Configuration{% endtrans %}</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="domain" class="form-label">{% trans %}Zone name{% endtrans %} <span class="text-danger">*</span></label>
                            <input data-testid="zone-name-input" class="form-control form-control-sm" type="text" id="domain" name="domain" value="{{ domain_value }}" required>
                            <div class="invalid-feedback">{% trans %}Provide zone name{% endtrans %}</div>
                            <small class="text-muted">{% trans %}Example: example.com{% endtrans %}</small>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="dom_type" class="form-label">{% trans %}Type{% endtrans %}</label>
                            <select data-testid="zone-type-select" class="form-select form-select-sm" id="dom_type" name="dom_type">
                                {% for type in available_zone_types %}
                                {% if type == dom_type_value %}
                                {% set selected = 'selected' %}
                                {% else %}
                                {% set selected = '' %}
                                {% endif %}
                                <option value="{{ type }}" {{ selected }}>{{type|lower}}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">{% trans %}Zone type (usually NATIVE){% endtrans %}</small>
                        </div>
                    </div>

                    {% if can_use_templates %}
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="zone_template" class="form-label">{% trans %}Template{% endtrans %}</label>
                            <select data-testid="zone-template-select" class="form-select form-select-sm" id="zone_template" name="zone_template">
                                <option value="none" {% if zone_template_value == 'none' %}selected{% endif %}>none</option>
                                {% for zone_template in zone_templates %}
                                <option value="{{ zone_template['id'] }}" {% if zone_template_value == zone_template['id'] %}selected{% endif %}>{{ zone_template['name'] }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">{% trans %}Optional: Apply predefined records from a template{% endtrans %}</small>
                        </div>
                    </div>
                    {% endif %}

                    {% if pdnssec_use %}
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label d-block">&nbsp;</label>
                            <div class="form-check">
                                <input data-testid="dnssec-checkbox" class="form-check-input" type="checkbox" id="dnssec" name="dnssec" value="1" {% if dnssec_checked %}checked{% endif %}>
                                <label class="form-check-label" for="dnssec">{% trans %}Enable DNSSEC{% endtrans %}</label>
                            </div>
                            <small class="text-muted">{% trans %}Secure this zone with DNSSEC signing{% endtrans %}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ownership (Side by Side) -->
<div class="row">
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3">
                <strong><i class="bi bi-person-badge me-2"></i>{% trans %}User Owner{% endtrans %}</strong>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <div class="alert alert-sm alert-success py-2 mb-2" id="selected_user_indicator" style="display: none;">
                        <small><strong>{% trans %}Selected:{% endtrans %}</strong> <span id="selected_user_name"></span></small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="owner" id="owner_none" value="" {% if owner_value == '' %}checked{% endif %}>
                        <label class="form-check-label" for="owner_none">
                            <strong>{% trans %}No user owner{% endtrans %}</strong>
                            <small class="text-muted d-block">{% trans %}Zone will be owned only by groups{% endtrans %}</small>
                        </label>
                    </div>
                </div>
                <hr class="my-2">
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm" id="user_search" placeholder="{% trans %}Search users...{% endtrans %}" autocomplete="off">
                </div>
                <div id="user_list" style="max-height: 200px; overflow-y: auto;">
                    {% for user in users %}
                    {% if perm_view_others or user['id'] == session_user_id %}
                    <div class="form-check mb-2 user-item" data-username="{{ user['fullname']|lower }} {{ user['username']|lower }}">
                        <input class="form-check-input" type="radio" name="owner" id="owner_{{ user['id'] }}" value="{{ user['id'] }}" {% if user['id'] == owner_value %}checked{% endif %}>
                        <label class="form-check-label" for="owner_{{ user['id'] }}">
                            {{ user['fullname'] }}
                            <small class="text-muted">({{ user['username'] }})</small>
                            {% if user['id'] == session_user_id %}<span class="badge bg-primary ms-1">{% trans %}You{% endtrans %}</span>{% endif %}
                        </label>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <small class="text-muted mt-2 d-block">{% trans %}Optional: Select a user responsible for this zone{% endtrans %}</small>
            </div>
        </div>
    </div>

    {% if all_groups is not empty %}
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3">
                <strong><i class="bi bi-people me-2"></i>{% trans %}Group Ownership{% endtrans %}</strong>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm" id="group_search" placeholder="{% trans %}Search groups...{% endtrans %}" autocomplete="off">
                </div>
                <div class="mb-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="select_all_groups">{% trans %}Select All{% endtrans %}</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect_all_groups">{% trans %}Clear All{% endtrans %}</button>
                </div>
                <div id="group_list" style="max-height: 200px; overflow-y: auto;">
                    {% for group in all_groups %}
                    <div class="form-check mb-2 group-item" data-groupname="{{ group.name|lower }}" data-groupdesc="{{ group.description|lower|default('') }}">
                        <input class="form-check-input group-checkbox" type="checkbox" name="groups[]" id="group_{{ group.id }}" value="{{ group.id }}" {% if selected_groups is defined and group.id in selected_groups %}checked{% endif %}>
                        <label class="form-check-label" for="group_{{ group.id }}">
                            {{ group.name }}
                            {% if group.description %}<small class="text-muted d-block">{{ group.description }}</small>{% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <small class="text-muted mt-2 d-block">{% trans %}Optional: Select one or more groups{% endtrans %}</small>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Action Buttons -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button data-testid="add-zone-button" class="btn btn-primary btn-sm" type="submit" name="submit">
                            <i class="bi bi-plus-circle me-1 text-white"></i>{% trans %}Add zone{% endtrans %}
                        </button>
                        <a href="{{ base_url_prefix }}/zones/forward" class="btn btn-secondary btn-sm">
                            <i class="bi bi-x-circle me-1 text-white"></i>{% trans %}Cancel{% endtrans %}
                        </a>
                    </div>
                    <small class="text-muted">{% trans %}* Required fields{% endtrans %}</small>
                </div>
            </div>
        </div>
    </div>
</div>

</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // User selection indicator and auto-scroll
    const userList = document.getElementById('user_list');
    const selectedIndicator = document.getElementById('selected_user_indicator');
    const selectedUserName = document.getElementById('selected_user_name');
    const ownerRadios = document.querySelectorAll('input[name="owner"]');

    function updateSelectedUserIndicator() {
        const selectedRadio = document.querySelector('input[name="owner"]:checked');
        if (selectedRadio && selectedRadio.value !== '') {
            const label = document.querySelector(`label[for="${selectedRadio.id}"]`);
            if (label) {
                selectedUserName.textContent = label.textContent.trim();
                selectedIndicator.style.display = 'block';
            }
        } else {
            selectedIndicator.style.display = 'none';
        }
    }

    // Show selected user on page load
    updateSelectedUserIndicator();

    // Auto-scroll to selected user
    const checkedRadio = document.querySelector('input[name="owner"]:checked');
    if (checkedRadio && checkedRadio.value !== '' && userList) {
        const checkedItem = checkedRadio.closest('.user-item');
        if (checkedItem) {
            userList.scrollTop = checkedItem.offsetTop - userList.offsetTop - 10;
        }
    }

    // Update indicator when selection changes
    ownerRadios.forEach(radio => {
        radio.addEventListener('change', updateSelectedUserIndicator);
    });

    // User search functionality
    const userSearch = document.getElementById('user_search');
    const userItems = document.querySelectorAll('.user-item');

    if (userSearch) {
        userSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();

            userItems.forEach(function(item) {
                const username = item.getAttribute('data-username');
                if (username.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Group search functionality
    const groupSearch = document.getElementById('group_search');
    const groupItems = document.querySelectorAll('.group-item');

    if (groupSearch) {
        groupSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();

            groupItems.forEach(function(item) {
                const groupname = item.getAttribute('data-groupname');
                const groupdesc = item.getAttribute('data-groupdesc');
                if (groupname.includes(searchTerm) || groupdesc.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Select all groups
    const selectAllBtn = document.getElementById('select_all_groups');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            const visibleCheckboxes = Array.from(document.querySelectorAll('.group-item'))
                .filter(item => item.style.display !== 'none')
                .map(item => item.querySelector('.group-checkbox'));

            visibleCheckboxes.forEach(checkbox => checkbox.checked = true);
        });
    }

    // Deselect all groups
    const deselectAllBtn = document.getElementById('deselect_all_groups');
    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.group-checkbox').forEach(checkbox => checkbox.checked = false);
        });
    }
});
</script>
