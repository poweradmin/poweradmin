<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ iface_title }}</title>
    <!-- CSS only -->
    <link href="{{ base_url_prefix }}/vendor/twbs/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ base_url_prefix }}/vendor/twbs/bootstrap-icons/font/bootstrap-icons.css">
    <script>
        // Determine correct theme before loading stylesheets to prevent FOUC
        const savedTheme = localStorage.getItem('style');
        const serverTheme = '{{ iface_style }}';
        const correctTheme = (savedTheme === 'light' || savedTheme === 'dark') ? savedTheme : serverTheme;
        
        // Load the correct stylesheet immediately
        document.write('<link id="theme-stylesheet" rel="stylesheet" href="{{ base_url_prefix }}/{{ theme_base_path }}/{{ theme }}/style/' + correctTheme + '.css?time={{ file_version }}" type="text/css">');
        {% if custom_theme_exists %}
        document.write('<link id="custom-theme-stylesheet" rel="stylesheet" href="{{ base_url_prefix }}/{{ theme_base_path }}/{{ theme }}/style/custom_' + correctTheme + '.css?time={{ file_version }}" type="text/css">');
        {% endif %}
    </script>
    <script type="text/javascript" src="{{ base_url_prefix }}/assets/helper.js?time={{ file_version }}"></script>
    <script type="text/javascript" src="{{ base_url_prefix }}/assets/userSettings.js?time={{ file_version }}"></script>
</head>
<body>

{% if current_page == 'mfa_verify' %}
<!-- MFA Verification - Simplified header with no navigation -->
<header class="mb-4">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-start">
            <a class="py-4 d-flex align-items-center my-2 my-lg-0 me-lg-auto text-decoration-none">
                <img class="me-2" src="{{ base_url_prefix }}/assets/logo.png" height="32">
                <span class="fs-4">{{ iface_title }}</span>
            </a>
            <!-- No navigation menu intentionally -->
        </div>
    </div>
</header>
{% elseif not user_logged_in %}
<!-- Regular header for non-logged-in users (login, forgot password, etc.) -->
<header class="mb-4">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            <a class="py-4 d-flex align-items-center my-2 my-lg-0 me-lg-auto text-decoration-none" href="/">
                {% if custom_header %}
                {% include ('custom/header.html') %}
                {% else %}
                <img class="me-2" src="{{ base_url_prefix }}/assets/logo.png" height="32">
                <span class="fs-4">{{ iface_title }}</span>
                {% endif %}
            </a>
        </div>
    </div>
</header>
{% else %}
<!-- Sidebar Layout with Top Bar -->
<div class="d-flex">
    {% if user_logged_in %}
    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Left Sidebar -->
    <nav class="sidebar bg-light border-end" id="sidebarNav">
        <div class="sidebar-header p-3 border-bottom d-flex align-items-center justify-content-between">
            <a href="/" class="d-flex align-items-center text-decoration-none">
                {% if custom_header %}
                {% include ('custom/header.html') %}
                {% else %}
                <img class="me-2" src="{{ base_url_prefix }}/assets/logo.png" height="24">
                <span class="fs-5">{{ iface_title }}</span>
                {% endif %}
            </a>
            <!-- Mobile close button -->
            <button class="btn btn-outline-secondary d-md-none sidebar-close" type="button" aria-label="Close navigation">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="d-block" id="sidebarContent">
            <div class="sidebar-content p-3">
                <ul class="nav nav-pills flex-column mb-auto">
                    <!-- Dashboard -->
                    <li class="nav-item">
                        <a href="/" class="nav-link {{ current_page == 'index' ? 'active' : '' }}">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </a>
                    </li>

                    {% if perm_search %}
                    <!-- Search -->
                    <li class="nav-item">
                        <a href="/search" class="nav-link {{ current_page == 'search' ? 'active' : '' }}">
                            <i class="bi bi-search me-2"></i>{% trans %}Search{% endtrans %}
                        </a>
                    </li>
                    {% endif %}

                    {% if perm_view_zone_own or perm_view_zone_other or perm_zone_master_add or perm_zone_slave_add %}
                    <!-- Zones Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <i class="bi bi-diagram-3 me-2"></i>{% trans %}Zones{% endtrans %}
                        </div>
                        <ul class="nav nav-pills flex-column ms-3">
                            {% if perm_view_zone_own or perm_view_zone_other %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'list_forward_zones' ? 'active' : '' }}" href="/zones/forward">
                                    <i class="bi bi-arrow-right me-2"></i>{% trans %}Forward zones{% endtrans %}
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'list_reverse_zones' ? 'active' : '' }}" href="/zones/reverse">
                                    <i class="bi bi-arrow-left me-2"></i>{% trans %}Reverse zones{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_zone_master_add %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'add_zone_master' ? 'active' : '' }}" href="/zones/add/master">
                                    <i class="bi bi-plus-circle me-2"></i>{% trans %}Add master zone{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_zone_slave_add %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'add_zone_slave' ? 'active' : '' }}" href="/zones/add/slave">
                                    <i class="bi bi-plus-circle-dotted me-2"></i>{% trans %}Add slave zone{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_zone_master_add %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'bulk_registration' ? 'active' : '' }}" href="/zones/bulk-registration">
                                    <i class="bi bi-collection me-2"></i>{% trans %}Bulk registration{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if iface_add_reverse_record and (perm_view_zone_own or perm_view_zone_other) %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'batch_ptr_record' ? 'active' : '' }}" href="/zones/batch-ptr">
                                    <i class="bi bi-arrow-repeat me-2"></i>{% trans %}Batch PTR Records{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_is_godlike and dblog_use == true %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'list_log_zones' ? 'active' : '' }}" href="/zones/logs">
                                    <i class="bi bi-list-ul me-2"></i>{% trans %}Zone logs{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}

                    {% if perm_view_others or perm_edit_others or perm_add_new or perm_is_godlike %}
                    <!-- Users Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <i class="bi bi-people me-2"></i>{% trans %}Users{% endtrans %}
                        </div>
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'users' ? 'active' : '' }}" href="/users">
                                    <i class="bi bi-person-lines-fill me-2"></i>{% trans %}User administration{% endtrans %}
                                </a>
                            </li>
                            {% if perm_add_new %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'add_user' ? 'active' : '' }}" href="/users/add">
                                    <i class="bi bi-person-plus me-2"></i>{% trans %}Add user{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_templ_perm_edit %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'list_perm_templ' ? 'active' : '' }}" href="/permissions/templates">
                                    <i class="bi bi-person-lock me-2"></i>{% trans %}List permission templates{% endtrans %}
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'add_perm_templ' ? 'active' : '' }}" href="/permissions/templates/add">
                                    <i class="bi bi-person-plus-fill me-2"></i>{% trans %}Add permission template{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_is_godlike and dblog_use == true %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'list_log_users' ? 'active' : '' }}" href="/users/logs">
                                    <i class="bi bi-journal-text me-2"></i>{% trans %}User logs{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}

                    {% if perm_zone_master_add %}
                    <!-- Templates -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <i class="bi bi-files me-2"></i>{% trans %}Templates{% endtrans %}
                        </div>
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'list_zone_templ' ? 'active' : '' }}" href="/zones/templates">
                                    <i class="bi bi-list me-2"></i>{% trans %}List zone templates{% endtrans %}
                                </a>
                            </li>
                            {% if perm_zone_templ_add %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'add_zone_templ' ? 'active' : '' }}" href="/zones/templates/add">
                                    <i class="bi bi-plus me-2"></i>{% trans %}Add zone template{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}

                    {% if ((not whois_restrict_to_admin or perm_is_godlike) and whois_enabled) or ((not rdap_restrict_to_admin or perm_is_godlike) and rdap_enabled) or (perm_is_godlike and api_enabled) or (perm_is_godlike and enable_consistency_checks) or (perm_is_godlike and email_previews_enabled) %}
                    <!-- Tools Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <i class="bi bi-tools me-2"></i>{% trans %}Tools{% endtrans %}
                        </div>
                        <ul class="nav nav-pills flex-column ms-3">
                            {% if (not whois_restrict_to_admin or perm_is_godlike) and whois_enabled %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'whois' ? 'active' : '' }}" href="/whois">
                                    <i class="bi bi-search-heart me-2"></i>{% trans %}WHOIS{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if (not rdap_restrict_to_admin or perm_is_godlike) and rdap_enabled %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'rdap' ? 'active' : '' }}" href="/rdap">
                                    <i class="bi bi-search-heart-fill me-2"></i>{% trans %}RDAP{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_is_godlike and api_enabled %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'api_keys' ? 'active' : '' }}" href="/settings/api-keys">
                                    <i class="bi bi-key-fill me-2"></i>{% trans %}API Keys{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_is_godlike and enable_consistency_checks %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'database_consistency' ? 'active' : '' }}" href="/tools/database-consistency">
                                    <i class="bi bi-database-check me-2"></i>{% trans %}Database Consistency{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if perm_is_godlike and email_previews_enabled %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'email_previews' ? 'active' : '' }}" href="/tools/email-previews">
                                    <i class="bi bi-envelope-fill me-2"></i>{% trans %}Email Template Previews{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if api_docs_enabled %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm" href="/api/docs" target="_blank">
                                    <i class="bi bi-book me-2"></i>{% trans %}API Documentation{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}

                    <!-- Account Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <i class="bi bi-person-circle me-2"></i>{% trans %}Account{% endtrans %}
                        </div>
                        <ul class="nav nav-pills flex-column ms-3">
                            {% if perm_edit_own %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'edit_user' and request.id == session_userid ? 'active' : '' }}" href="/users/{{ session_userid }}/edit">
                                    <i class="bi bi-person-gear me-2"></i>{% trans %}Edit profile{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if can_change_password %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'change_password' ? 'active' : '' }}" href="/password/change">
                                    <i class="bi bi-key me-2"></i>{% trans %}Change password{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            {% if mfa_enabled %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'mfa_setup' ? 'active' : '' }}" href="/mfa/setup">
                                    <i class="bi bi-shield-lock me-2"></i>{% trans %}Multi-Factor Authentication{% endtrans %}
                                </a>
                            </li>
                            {% endif %}
                            <li class="nav-item">
                                <a class="nav-link nav-link-sm {{ current_page == 'logout' ? 'active' : '' }}" href="/logout">
                                    <i class="bi bi-box-arrow-right me-2"></i>{% trans %}Logout{% endtrans %}
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>

                <!-- Version info at bottom of sidebar -->
                <div class="sidebar-version mt-auto pt-3 border-top">
                    <small class="text-muted">
                        <a href="https://www.poweradmin.org/" class="text-decoration-none text-muted">
                            Poweradmin v{{ version }}
                        </a>
                    </small>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Main content area -->
    <div class="main-content flex-grow-1">
        {% if user_logged_in %}
        <!-- Top bar for logged-in users -->
        <header class="top-bar bg-white border-bottom p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary d-md-none me-3 sidebar-toggle" type="button" aria-label="Toggle navigation">
                        <i class="bi bi-list"></i>
                    </button>
                    <h1 class="h5 mb-0">
                        {% if current_page == 'index' %}{% trans %}Dashboard{% endtrans %}
                        {% elseif current_page == 'search' %}{% trans %}Search{% endtrans %}
                        {% elseif current_page == 'list_forward_zones' %}{% trans %}Forward Zones{% endtrans %}
                        {% elseif current_page == 'list_reverse_zones' %}{% trans %}Reverse Zones{% endtrans %}
                        {% elseif current_page == 'users' %}{% trans %}Users{% endtrans %}
                        {% elseif current_page == 'list_zone_templ' %}{% trans %}Templates{% endtrans %}
                        {% else %}{{ iface_title }}{% endif %}
                    </h1>
                </div>
                <div class="d-flex align-items-center">
                    {% if user_avatar_url %}
                        <img src="{{ user_avatar_url }}" alt="User Avatar" class="rounded-circle me-2" width="24" height="24" style="object-fit: cover;">
                    {% else %}
                        <i class="bi bi-person-circle me-2"></i>
                    {% endif %}
                    <span class="me-3">{{ user_name }}</span>
                    <button class="btn btn-outline-secondary btn-sm me-2" id="style-switcher">
                        <i class="bi" id="style-icon"></i>
                    </button>
                    <a href="/logout" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i>{% trans %}Logout{% endtrans %}
                    </a>
                </div>
            </div>
        </header>
        {% else %}
        <!-- Regular header for non-logged-in users -->
        <header class="mb-4">
            <div class="container">
                <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                    <a class="py-4 d-flex align-items-center my-2 my-lg-0 me-lg-auto text-decoration-none" href="/">
                        {% if custom_header %}
                        {% include ('custom/header.html') %}
                        {% else %}
                        <img class="me-2" src="{{ base_url_prefix }}/assets/logo.png" height="32">
                        <span class="fs-4">{{ iface_title }}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </header>
        {% endif %}
{% endif %}

{% if install_error %}
<div class="container">
    <div class="alert alert-danger bg-danger bg-opacity-10 py-2 border border-danger install-error small" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>
        <strong class="text-danger">Error:</strong> <span class="text-danger">{{ install_error | raw }}</span>
    </div>
</div>
{% endif %}

{% if user_logged_in %}
{% if session_key_error %}
<div class="container">
    <div data-testid="error-message" class="alert alert-danger bg-danger bg-opacity-10"><strong class="text-danger">Error:</strong> {{ session_key_error | raw }}</div>
</div>
{% endif %}
{% endif %}

<main class="container pb-3 flex-shrink-0">
{% if system_messages is defined and system_messages %}
    {% for message in system_messages %}
    <div class="alert alert-{% if message.type == 'error' %}danger{% elseif message.type == 'warn' %}warning{% else %}{{ message.type }}{% endif %} bg-{% if message.type == 'error' %}danger{% elseif message.type == 'warn' %}warning{% else %}{{ message.type }}{% endif %} bg-opacity-10 py-2 border border-{% if message.type == 'error' %}danger{% elseif message.type == 'warn' %}warning{% else %}{{ message.type }}{% endif %} alert-dismissible small fade show" role="alert" data-testid="system-message">
        <i class="bi bi-{% if message.type == 'error' %}exclamation-triangle{% elseif message.type == 'warn' %}exclamation-circle{% elseif message.type == 'success' %}check-circle{% else %}info-circle{% endif %}-fill me-2 text-{% if message.type == 'error' %}danger{% elseif message.type == 'warn' %}warning{% else %}{{ message.type }}{% endif %}"></i>
        <strong class="text-{% if message.type == 'error' %}danger{% elseif message.type == 'warn' %}warning{% else %}{{ message.type }}{% endif %}">{% if message.type == 'error' %}Error:{% elseif message.type == 'warn' %}Warning:{% elseif message.type == 'success' %}Success:{% else %}Info:{% endif %}</strong> {{ message.content | raw }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}